<div fxFlexFill fxLayout="column">
  <div fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="16px">
    <mat-form-field fxFlex appearance="fill" *ngIf="!disableSearch">
      <mat-label>Search <span *ngIf="data?.length as dataLength">{{dataLength}} record{{dataLength === 1 ? '' : 's'}}</span></mat-label>
      <mat-icon class="stretch-badge" matPrefix [matBadge]="data && filteredData.length !== data.length ? (filteredData.length | number) : null" matBadgePosition="above before">search</mat-icon>
      <input #filterInput="matInput" matInput type="text" [value]="filter" (keyup)="filter$.next(filterInput.value)" [disabled]="!data?.length">
      <button *ngIf="filterInput.value" matSuffix mat-icon-button aria-label="Clear" (click)="clearFilter(filterInput)">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <button mat-mini-fab *ngIf="!disableOptions" [matMenuTriggerFor]="tableOptions">
      <mat-icon>settings</mat-icon>
    </button>
    <mat-menu #tableOptions="matMenu">
      <button mat-menu-item [matMenuTriggerFor]="toggleColumnMenu" [disabled]="!columns.length">Display columns</button>
      <mat-menu #toggleColumnMenu="matMenu">
        <button mat-menu-item
                (click)="toggleColumnHide(col, $event)"
                fxLayout="row"
                fxLayoutGap="10px"
                fxLayoutAlign="space-between center"
                *ngFor="let col of columns">
          <mat-icon [color]="col.hide ? 'warn' : 'accent'">
            {{col.hide ? 'check_box_outline_blank' : 'check_box'}}
          </mat-icon>
          <div>{{col.title}}</div>
        </button>
      </mat-menu>
      <button mat-menu-item (click)="exportData()" [disabled]="!data?.length">Export data to .csv</button>
      <button mat-menu-item (click)="resetCached()">Clear Cache</button>
    </mat-menu>
  </div>
  <table fxFlex fxLayout="column" cdkVirtualScrollingElement>
    <tr class="sticky header mat-app-background mat-elevation-z4 border-bottom"
        fxLayout="row"
        [style.minWidth.px]="minRowWidth"
        cdkDropList
        cdkDropListOrientation="horizontal"
        cdkDropListLockAxis="x"
        cdkDropListAutoScrollDisabled
        matSort
        [matSortActive]="sort.active"
        [matSortDirection]="sort.direction"
        (matSortChange)="sortData($event)"
        (cdkDropListDropped)="changeColumnOrder($event)">
      <th *ngIf="!disableSelection" [style.minWidth.px]="stickyCellWidth" class="sticky mat-app-background left" fxLayoutAlign="center center">
        <div class="selection-count" *ngIf="selection.selected.length as selected">{{selected | number}}</div>
        <mat-checkbox [disabled]="disableSelectAll || !data?.length"
                      (change)="selectAllToggle()"
                      [checked]="selection.hasValue() && isAllSelected()"
                      [indeterminate]="selection.hasValue() && !isAllSelected()"></mat-checkbox>
      </th>
      <th *ngIf="!visibleColumns.length" fxFlex></th>
      <th *ngFor="let column of visibleColumns"
          [fxFlex]="column.fxFlex"
          [fxLayoutAlign]="column.fxLayoutAlign"
          (mouseenter)="mouseoverColumn = column"
          (mouseleave)="mouseoverColumn = null"
          class="cell mat-app-background"
          cdkDrag
          cdkDragBoundary=".header">
        <div [fxFlex]="column.fxFlex" *cdkDragPlaceholder></div>
        <div *ngIf="column === mouseoverColumn" class="column-mouseover" [ngClass]="column.fxLayoutAlign === 'end center' ? 'left' : 'right'">
          <svg class="column-filter" width="16px" fill="currentColor" viewBox="0 0 48 48">
            <path d="M22 40q-.85 0-1.425-.575Q20 38.85 20 38V26L8.05 10.75q-.7-.85-.2-1.8Q8.35 8 9.4 8h29.2q1.05 0 1.55.95t-.2 1.8L28 26v12q0 .85-.575 1.425Q26.85 40 26 40Zm2-13.8L36 11H12Zm0 0Z"/>
          </svg>
          <svg cdkDragHandle width="16px" fill="currentColor" viewBox="0 0 24 24">
            <path d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"></path>
            <path d="M0 0h24v24H0z" fill="none"></path>
          </svg>
        </div>
        <div [mat-sort-header]="column.field" [arrowPosition]="column.fxLayoutAlign === 'end center' ? 'before' : 'after'">{{column.title}}</div>
      </th>
      <th *ngIf="tableMenuItems || rowMenuItems" [style.width.px]="stickyCellWidth" class="sticky mat-app-background right" fxLayoutAlign="center center">
        <button *ngIf="tableMenuItems" mat-icon-button>
          <mat-icon>drag_indicator</mat-icon>
        </button>
      </th>
    </tr>
    <cdk-virtual-scroll-viewport [itemSize]="rowHeight" fxFlex>
      <mat-progress-bar *ngIf="!data" mode="indeterminate" color="primary"></mat-progress-bar>
      <tr *cdkVirtualFor="let row of filteredData; let last = last"
          [style.minWidth.px]="minRowWidth"
          [style.minHeight.px]="rowHeight"
          fxLayout="row"
          class="border-sides"
          [ngClass]="{'border-bottom': !last}">
        <td *ngIf="!disableSelection" [style.minWidth.px]="stickyCellWidth" class="sticky mat-app-background left" fxLayoutAlign="center center">
          <mat-checkbox (click)="rowSelect($event, row)" (change)="selection.toggle(row)" [checked]="selection.isSelected(row)"></mat-checkbox>
        </td>
        <td *ngIf="!visibleColumns.length" fxFlex></td>
        <td *ngFor="let column of visibleColumns; let first = first;" [fxFlex]="column.fxFlex" [fxLayoutAlign]="column.fxLayoutAlign">
          {{row[column.field]}}
        </td>
        <td *ngIf="tableMenuItems || rowMenuItems" [style.width.px]="stickyCellWidth" class="sticky mat-app-background right" fxLayoutAlign="center center">
          <button *ngIf="rowMenuItems" mat-icon-button>
            <mat-icon>more_vert</mat-icon>
          </button>
        </td>
      </tr>
    </cdk-virtual-scroll-viewport>
    <tr *ngIf="data && showFooter" class="sticky footer mat-app-background mat-elevation-z4 border-top" fxLayout="row" [style.minWidth.px]="minRowWidth">
      <td *ngIf="!disableSelection" [style.minWidth.px]="stickyCellWidth" class="sticky mat-app-background left"></td>
      <td *ngIf="!visibleColumns.length" fxFlex></td>
      <td *ngFor="let column of visibleColumns" [fxFlex]="column.fxFlex" [fxLayoutAlign]="column.fxLayoutAlign">
        <div *ngIf="column.sum" [ngSwitch]="column.dataType">
          <div *ngSwitchCase="columnDataTypes.currency">{{calculateColumnSum(column) | currency:'USD':'$' | accounting}}</div>
          <div *ngSwitchCase="columnDataTypes.number">{{calculateColumnSum(column) | number:column.format}}</div>
          <div *ngSwitchDefault>-</div>
        </div>
      </td>
      <td *ngIf="tableMenuItems || rowMenuItems" [style.width.px]="stickyCellWidth" class="sticky mat-app-background right"></td>
    </tr>
  </table>
</div>
