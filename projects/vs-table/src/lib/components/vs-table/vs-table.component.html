<div class="vs-table" fxLayout="column">
  <div fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="16px">
    <mat-form-field fxFlex appearance="fill" *ngIf="!disableSearch">
      <mat-label>Search <span *ngIf="data?.length as dataLength">{{dataLength}} record{{dataLength === 1 ? '' : 's'}}</span></mat-label>
      <mat-icon class="stretch-badge" matPrefix [matBadge]="data && filteredData.length !== data.length ? (filteredData.length | number) : null" matBadgePosition="above before">search</mat-icon>
      <input #filterInput="matInput" matInput type="text" [value]="filter" (keyup)="filter$.next(filterInput.value)" [disabled]="!data?.length">
      <button *ngIf="filterInput.value" matSuffix mat-icon-button aria-label="Clear" (click)="clearFilter(filterInput)">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <button mat-mini-fab *ngIf="!disableOptions" [matMenuTriggerFor]="tableOptions">
      <mat-icon>settings</mat-icon>
    </button>
    <mat-menu #tableOptions="matMenu">
      <button mat-menu-item [matMenuTriggerFor]="toggleColumnMenu" [disabled]="!columns.length">Display columns</button>
      <mat-menu #toggleColumnMenu="matMenu">
        <button mat-menu-item
                (click)="toggleColumnHide(col, $event)"
                fxLayout="row"
                fxLayoutGap="10px"
                fxLayoutAlign="space-between center"
                *ngFor="let col of columns">
          <mat-icon [color]="col.hide ? 'warn' : 'accent'">
            {{col.hide ? 'check_box_outline_blank' : 'check_box'}}
          </mat-icon>
          <div>{{col.title}}</div>
        </button>
      </mat-menu>
      <button mat-menu-item (click)="exportData()" [disabled]="!data?.length">Export data to .csv</button>
      <button mat-menu-item (click)="resetCached()">Clear Cache</button>
    </mat-menu>
  </div>
  <table fxFlex fxLayout="column" cdkVirtualScrollingElement>
    <tr class="sticky header mat-app-background mat-elevation-z4 border-bottom"
        fxLayout="row"
        [style.minWidth.px]="minRowWidth"
        cdkDropList
        cdkDropListOrientation="horizontal"
        cdkDropListLockAxis="x"
        cdkDropListAutoScrollDisabled
        matSort
        [matSortActive]="sort.active"
        [matSortDirection]="sort.direction"
        (matSortChange)="sortData($event)"
        (cdkDropListDropped)="changeColumnOrder($event)">
      <th *ngIf="!disableSelection" [style.minWidth.px]="stickyCellWidth" class="sticky mat-app-background left" fxLayoutAlign="center center">
        <div class="selection-count" *ngIf="selection.selected.length as selected">{{selected | number}}</div>
        <mat-checkbox [disabled]="disableSelectAll || !data?.length"
                      (change)="selectAllToggle()"
                      [checked]="selection.hasValue() && isAllSelected()"
                      [indeterminate]="selection.hasValue() && !isAllSelected()"></mat-checkbox>
      </th>
      <th *ngIf="!visibleColumns.length" fxFlex></th>
      <th *ngFor="let column of visibleColumns"
          [fxFlex]="column.fxFlex"
          [fxLayoutAlign]="column.fxLayoutAlign"
          (mouseenter)="mouseoverColumn = column"
          (mouseleave)="mouseoverColumn = null"
          class="cell mat-app-background"
          cdkDrag
          cdkDragBoundary=".header">
        <div [fxFlex]="column.fxFlex" *cdkDragPlaceholder></div>
        <mat-icon *ngIf="column === mouseoverColumn"
                  [ngClass]="column.fxLayoutAlign === 'end center' ? 'left' : 'right'"
                  cdkDragHandle>
          drag_handle
        </mat-icon>
        <mat-icon class="column-filter"
                  *ngIf="column === mouseoverColumn || columnFilters[column.field]"
                  [ngClass]="column.fxLayoutAlign === 'end center' ? 'left' : 'right'"
                  [matMenuTriggerFor]="columnFilter"
                  (click)="columnFilters[column.field] = column"
                  [color]="columnFilters[column.field] ? 'accent' : undefined">
          filter_alt
        </mat-icon>
        <mat-icon *ngIf="columnFilters[column.field]"
                  [ngClass]="column.fxLayoutAlign === 'end center' ? 'left' : 'right'"
                  class="column-filter"
                  style="bottom: 0"
                  (click)="columnFilters[column.field] = undefined"
                  color="warn">
          close
        </mat-icon>
        <div [mat-sort-header]="column.field" [arrowPosition]="column.fxLayoutAlign === 'end center' ? 'before' : 'after'">{{column.title}}</div>
        <mat-menu #columnFilter="matMenu" (close)="columnFilters[column.field] = undefined">
          <button mat-menu-item>Test1</button>
          <button mat-menu-item>Test2</button>
          <button mat-menu-item>Test3</button>
<!--          <div fxLayout="column" (click)="$event.stopPropagation()">-->
<!--            <mat-form-field class="side-pad" color="accent">-->
<!--              <input autocomplete="off"-->
<!--                     matInput-->
<!--                     #colSearchInput="matInput"-->
<!--                     [value]="column.value$.value"-->
<!--                     (keyup)="column.value$.next(colSearchInput.value)"-->
<!--                     placeholder="Search by {{column.title}}">-->
<!--              <button *ngIf="column.value$.value" matSuffix mat-icon-button aria-label="Clear" (click)="clearColumnFilters(false, true, column, $event)">-->
<!--                <mat-icon color="warn">close</mat-icon>-->
<!--              </button>-->
<!--            </mat-form-field>-->
<!--            <div class="column-search" fxLayout="column" *ngIf="column.selection.selected.length">-->
<!--              <div class="column-search-row" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px" *ngFor="let s of column.selection.selected">-->
<!--                <mat-icon color="warn" class="clear-selected" (click)="selectColumnValue(false, s, column)">close</mat-icon>-->
<!--                <div class="column-search-text" [ngStyle]="{fontWeight: s === null ? 'bold' : null}" [fxLayoutAlign]="column.fxLayoutAlign">-->
<!--                  {{s === null ? nullColumnValue : s}}-->
<!--                </div>-->
<!--              </div>-->
<!--            </div>-->
<!--            <mat-divider class="col-filter-divider"></mat-divider>-->
<!--            <div class="column-search-row" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">-->
<!--              <mat-checkbox [checked]="column.selection.isSelected(null)" (change)="selectColumnValue($event.checked, null, column)"></mat-checkbox>-->
<!--              <div class="column-search-text" [ngStyle]="{fontWeight: 'bold'}" [fxLayoutAlign]="column.fxLayoutAlign">-->
<!--                {{ nullColumnValue }}-->
<!--              </div>-->
<!--            </div>-->
<!--            <mat-divider class="col-filter-divider"></mat-divider>-->
<!--            <cdk-virtual-scroll-viewport itemSize="30"-->
<!--                                         minBufferPx="200"-->
<!--                                         maxBufferPx="400"-->
<!--                                         (click)="$event.stopPropagation()"-->
<!--                                         class="column-search-selection">-->
<!--              <div *cdkVirtualFor="let cv of filteredUniqueColumnValues; first as first;" fxLayout="column">-->
<!--                <div class="column-search-row" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="10px">-->
<!--                  <mat-checkbox [checked]="column.selection.isSelected(cv)" (change)="selectColumnValue($event.checked, cv, column)"></mat-checkbox>-->
<!--                  <div class="column-search-text" [fxLayoutAlign]="column.fxLayoutAlign">-->
<!--                    {{cv}}-->
<!--                  </div>-->
<!--                </div>-->
<!--              </div>-->
<!--            </cdk-virtual-scroll-viewport>-->
<!--          </div>-->
        </mat-menu>
      </th>
      <th *ngIf="tableMenuItems || rowMenuItems" [style.width.px]="stickyCellWidth" class="sticky mat-app-background right" fxLayoutAlign="center center">
        <button *ngIf="tableMenuItems" mat-icon-button>
          <mat-icon>drag_indicator</mat-icon>
        </button>
      </th>
    </tr>
    <cdk-virtual-scroll-viewport [itemSize]="rowHeight" fxFlex>
      <mat-progress-bar *ngIf="!data" mode="indeterminate" color="primary"></mat-progress-bar>
      <h1 *ngIf="data && !filteredData.length">No results found</h1>
      <tr *cdkVirtualFor="let row of filteredData; let last = last"
          [style.minWidth.px]="minRowWidth"
          [style.minHeight.px]="rowHeight"
          fxLayout="row"
          class="border-sides"
          [ngClass]="{'border-bottom': !last}">
        <td *ngIf="!disableSelection" [style.minWidth.px]="stickyCellWidth" class="sticky mat-app-background left" fxLayoutAlign="center center">
          <mat-checkbox (click)="rowSelect($event, row)" (change)="selection.toggle(row)" [checked]="selection.isSelected(row)"></mat-checkbox>
        </td>
        <td *ngIf="!visibleColumns.length" fxFlex></td>
        <td *ngFor="let column of visibleColumns; let first = first;" [fxFlex]="column.fxFlex" [fxLayoutAlign]="column.fxLayoutAlign">
          {{row[column.field]}}
        </td>
        <td *ngIf="tableMenuItems || rowMenuItems" [style.width.px]="stickyCellWidth" class="sticky mat-app-background right" fxLayoutAlign="center center">
          <button *ngIf="rowMenuItems" mat-icon-button>
            <mat-icon>more_vert</mat-icon>
          </button>
        </td>
      </tr>
    </cdk-virtual-scroll-viewport>
    <tr *ngIf="data && showFooter" class="sticky footer mat-app-background mat-elevation-z4 border-top" fxLayout="row" [style.minWidth.px]="minRowWidth">
      <td *ngIf="!disableSelection" [style.minWidth.px]="stickyCellWidth" class="sticky mat-app-background left"></td>
      <td *ngIf="!visibleColumns.length" fxFlex></td>
      <td *ngFor="let column of visibleColumns" [fxFlex]="column.fxFlex" [fxLayoutAlign]="column.fxLayoutAlign">
        <div *ngIf="column.sum" [ngSwitch]="column.dataType">
          <div *ngSwitchCase="columnDataTypes.currency">{{calculateColumnSum(column) | currency:'USD':'$' | accounting}}</div>
          <div *ngSwitchCase="columnDataTypes.number">{{calculateColumnSum(column) | number:column.format}}</div>
          <div *ngSwitchDefault>-</div>
        </div>
      </td>
      <td *ngIf="tableMenuItems || rowMenuItems" [style.width.px]="stickyCellWidth" class="sticky mat-app-background right"></td>
    </tr>
  </table>
</div>
